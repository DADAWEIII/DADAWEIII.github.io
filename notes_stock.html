<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票學習筆記 | 張達瑋</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .page-hidden { display: none; }
        .note-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            word-break: break-word; /* 避免長標題撐開版面 */
        }
        .note-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body>
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="goals.html" id="back-link" class="text-sky-600 hover:text-sky-800 transition font-semibold">&larr; 返回學習與成長</a>
            <h1 id="header-title" class="text-xl font-bold text-slate-800">股票學習筆記</h1>
        </div>
    </header>

    <main class="container mx-auto px-6 py-12">
        <div id="list-page">
            <div id="notes-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                <button id="add-new-note-btn" class="note-card aspect-square flex flex-col justify-center items-center bg-slate-100 hover:bg-slate-200 rounded-lg p-4 text-center border-2 border-dashed border-slate-300">
                    <svg class="w-12 h-12 text-slate-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                    <span class="font-semibold text-slate-600 mt-2">新增筆記</span>
                </button>
                </div>
        </div>

        <div id="editor-page" class="page-hidden">
            <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-lg">
                <input type="text" id="note-title" class="w-full text-3xl font-bold text-slate-800 mb-6 border-b-2 pb-2 focus:outline-none focus:border-sky-500" placeholder="請輸入標題...">
                <textarea id="note-content" class="w-full h-96 p-4 border border-slate-300 rounded-md focus:ring-2 focus:ring-sky-500 transition" placeholder="在這裡記錄您的學習重點..."></textarea>
                <div class="mt-6 flex items-center justify-between">
                    <button id="delete-button" class="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600 transition-colors">刪除筆記</button>
                    <div class="flex items-center space-x-4">
                        <p id="status-message" class="text-green-600 font-semibold"></p>
                        <button id="save-button" class="bg-sky-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-sky-600 transition-colors">儲存筆記</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM 元素宣告 ---
            const listPage = document.getElementById('list-page');
            const editorPage = document.getElementById('editor-page');
            const notesGrid = document.getElementById('notes-grid');
            const addNewNoteBtn = document.getElementById('add-new-note-btn');
            const noteTitleInput = document.getElementById('note-title');
            const noteContentInput = document.getElementById('note-content');
            const saveButton = document.getElementById('save-button');
            const deleteButton = document.getElementById('delete-button');
            const statusMessage = document.getElementById('status-message');
            const headerTitle = document.getElementById('header-title');
            const backLink = document.getElementById('back-link');

            // --- Key 設定 (此為股票版本) ---
            const notesStorageKey = 'davie_stockNotes_v2'; // 新的多筆記儲存 Key
            const oldNotesKey = 'davie_stockNotes'; // 舊的單篇筆記 Key (用於資料遷移)

            let currentEditingNoteId = null;

            // --- 主要功能函式 ---

            /**
             * 功能: 獲取所有筆記，如果不存在則進行資料遷移
             */
            function getNotes() {
                const notesJSON = localStorage.getItem(notesStorageKey);
                if (!notesJSON) { // 如果新格式資料不存在，就嘗試從舊格式遷移
                    const oldContent = localStorage.getItem(oldNotesKey);
                    if (oldContent && oldContent.trim() !== '') {
                        const migratedNotes = [{
                            id: Date.now(),
                            title: '自動匯入的筆記',
                            content: oldContent,
                            lastModified: new Date().toISOString()
                        }];
                        saveNotes(migratedNotes);
                        localStorage.removeItem(oldNotesKey); // 遷移後移除舊資料
                        return migratedNotes;
                    }
                    return []; // 沒有任何舊資料
                }
                return JSON.parse(notesJSON);
            }

            /**
             * 功能: 儲存筆記陣列
             */
            function saveNotes(notes) {
                localStorage.setItem(notesStorageKey, JSON.stringify(notes));
            }

            /**
             * 功能: 渲染筆記列表 (所有的小方格)
             */
            function renderNotesList() {
                const notes = getNotes().sort((a, b) => new Date(b.lastModified) - new Date(a.lastModified));
                // 清空舊的方格 (保留新增按鈕)
                document.querySelectorAll('.note-card-item').forEach(el => el.remove());

                notes.forEach(note => {
                    const noteEl = document.createElement('a');
                    noteEl.href = '#';
                    noteEl.className = 'note-card note-card-item aspect-square flex flex-col bg-white rounded-lg p-4 shadow-sm border';
                    noteEl.dataset.noteId = note.id;
                    const title = note.title || '無標題';
                    const contentPreview = note.content.substring(0, 100);
                    noteEl.innerHTML = `
                        <h3 class="font-bold text-slate-800 mb-2 flex-shrink-0">${title}</h3>
                        <p class="text-sm text-slate-500 overflow-hidden flex-grow">${contentPreview}</p>
                        <time class="text-xs text-slate-400 mt-2 self-start flex-shrink-0">${new Date(note.lastModified).toLocaleDateString()}</time>
                    `;
                    notesGrid.appendChild(noteEl);
                    noteEl.addEventListener('click', (e) => {
                        e.preventDefault();
                        showEditorPage(note.id);
                    });
                });
            }

            /**
             * 功能: 顯示列表頁 (小方格頁)
             */
            function showListPage() {
                listPage.classList.remove('page-hidden');
                editorPage.classList.add('page-hidden');
                headerTitle.textContent = '股票學習筆記';
                backLink.innerHTML = '&larr; 返回學習與成長';
                backLink.onclick = () => window.location.href = 'goals.html';
                currentEditingNoteId = null;
                renderNotesList();
            }

            /**
             * 功能: 顯示編輯頁 (單一筆記內容頁)
             */
            function showEditorPage(noteId) {
                listPage.classList.add('page-hidden');
                editorPage.classList.remove('page-hidden');
                currentEditingNoteId = noteId;

                // 更改返回按鈕的行為，讓它返回列表頁而不是 goals.html
                backLink.innerHTML = '&larr; 返回筆記列表';
                backLink.onclick = (e) => { e.preventDefault(); showListPage(); };

                if (noteId) { // 編輯現有筆記
                    const note = getNotes().find(n => n.id === noteId);
                    noteTitleInput.value = note.title;
                    noteContentInput.value = note.content;
                    deleteButton.style.display = 'block';
                    headerTitle.textContent = '編輯筆記';
                } else { // 新增筆記
                    noteTitleInput.value = '';
                    noteContentInput.value = '';
                    deleteButton.style.display = 'none';
                    headerTitle.textContent = '新增筆記';
                }
            }

            // --- 事件監聽 ---
            addNewNoteBtn.addEventListener('click', () => showEditorPage(null));

            saveButton.addEventListener('click', () => {
                const title = noteTitleInput.value.trim();
                const content = noteContentInput.value.trim();
                if (!title && !content) return alert('標題和內容不能都為空！');

                let notes = getNotes();
                if (currentEditingNoteId) { // 更新
                    const noteIndex = notes.findIndex(n => n.id === currentEditingNoteId);
                    if (noteIndex > -1) {
                        notes[noteIndex] = { ...notes[noteIndex], title, content, lastModified: new Date().toISOString() };
                    }
                } else { // 新增
                    notes.push({ id: Date.now(), title, content, lastModified: new Date().toISOString() });
                }
                saveNotes(notes);
                statusMessage.textContent = '儲存成功！';
                setTimeout(() => { statusMessage.textContent = ''; showListPage(); }, 1000);
            });

            deleteButton.addEventListener('click', () => {
                if (currentEditingNoteId && confirm('確定要刪除這則筆記嗎？此操作無法復原。')) {
                    let notes = getNotes().filter(n => n.id !== currentEditingNoteId);
                    saveNotes(notes);
                    showListPage();
                }
            });

            // --- 初始載入 ---
            showListPage();
        });
    </script>
</body>
</html>
